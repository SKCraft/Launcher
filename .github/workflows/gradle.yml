name: Java CI
on:
  push:
    tags:
      - '*'
jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v1
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: Get the version
      id: get_version
      run: echo ::set-output name=VERSION::$(echo $GITHUB_REF | cut -d / -f 3)
      
    - name: Build with Gradle
      run: ./gradlew clean build createExe
    

    - name: Upload launcher to release
      uses: svenstaro/upload-release-action@v1-release
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: launcher/build/libs/launcher-${{ steps.get_version.outputs.VERSION }}.jar
        asset_name: launcher-${{ steps.get_version.outputs.VERSION }}.jar
        tag: ${{ github.ref }}
        overwrite: true
    - name: Upload launcher fancy to release
      uses: svenstaro/upload-release-action@v1-release
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: launcher-fancy/build/libs/launcher-fancy-${{ steps.get_version.outputs.VERSION }}.jar
        asset_name: launcher-fancy-${{ steps.get_version.outputs.VERSION }}.jar
        tag: ${{ github.ref }}
        overwrite: true
    - name: Upload launcher builder to release
      uses: svenstaro/upload-release-action@v1-release
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: launcher-builder/build/libs/launcher-builder-${{ steps.get_version.outputs.VERSION }}.jar
        asset_name: launcher-builder.jar
        tag: ${{ github.ref }}
        overwrite: true
    - name: Upload launcher bootstrap to release
      uses: svenstaro/upload-release-action@v1-release
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: launcher-bootstrap/build/libs/launcher-bootstrap-${{ steps.get_version.outputs.VERSION }}.jar
        asset_name: Mineaurion_Launcher.jar
        tag: ${{ github.ref }}
        overwrite: true
    - name: Upload launcher bootstrap exe to release
      uses: svenstaro/upload-release-action@v1-release
      with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file:  launcher-bootstrap/build/launch4j/launcher-bootstrap.exe
          asset_name: Mineaurion_Launcher.exe
          tag: ${{ github.ref }}
          overwrite: true
    - name: Install swiftclient
      run: pip install python-swiftclient python-keystoneclient
    - name: Upload new version to bucket
      env:
          OS_USERNAME: ${{ secrets.OS_USERNAME }}
          OS_PASSWORD: ${{ secrets.OS_PASSWORD }}
          CONTAINER_URL: ${{ secrets.CONTAINER_URL }}
      run: |
        swift="swift --os-auth-url https://auth.cloud.ovh.net/v3 --auth-version 3 --os-project-name 5082960922491074 --os-project-domain-id default  --os-username ${OS_USERNAME} --os-password ${OS_PASSWORD} --os-region-name GRA"
        version=${{ steps.get_version.outputs.VERSION }}
        url="${CONTAINER_URL}/versions/$version.jar"
        jq --null-input --arg version "$version" --arg url "$url" '{ "version": $version, "url": $url}' > latest.json
        $swift upload modpack launcher-fancy/build/libs/launcher-fancy-$version.jar --object-name versions/$version.jar
        $swift upload modpack latest.json --object-name versions/latest.json
        
        
